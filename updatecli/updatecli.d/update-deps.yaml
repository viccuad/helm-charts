name: Update charts with new policy versions, kubectl image

sources:
  kubectlImageTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-controller/values.yaml"
      key: "$.preDeleteJob.image.tag"
  allowPrivilegeEscalationPolicyTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.allowPrivilegeEscalationPolicy.module.tag"
  hostNamespacePolicyTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.hostNamespacePolicy.module.tag"
  podPrivilegedPolicyTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.podPrivilegedPolicy.module.tag"
  userGroupPolicyTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.userGroupPolicy.module.tag"
  hostPathsPolicyTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.hostPathsPolicy.module.tag"
  capabilitiesPolicyTag:
    kind: yaml
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.capabilitiesPolicy.module.tag"

conditions:
  iskubectlImageCurrent:
    name: Is there a new kubewarden/kubectl tag
    kind: dockerimage
    sourceid: kubectlImageTag
    spec:
      image: ghcr.io/kubewarden/kubectl
  isAllowPrivilegeEscalationPolicyCurrent:
    name: Is there a new privilege-escalation-psp tag
    kind: dockerimage
    sourceid: allowPrivilegeEscalationPolicyTag
    spec:
      image: ghcr.io/kubewarden/policies/allow-privilege-escalation-psp
  isHostNamespacePolicyCurrent:
    name: Is there a new host-namespaces-psp tag
    kind: dockerimage
    sourceid: hostNamespacePolicyTag
    spec:
      image: ghcr.io/kubewarden/policies/host-namespaces-psp
  isPodPrivilegedPolicyCurrent:
    name: Is there a new pod-privileged tag
    kind: dockerimage
    sourceid: podPrivilegedPolicyTag
    spec:
      image: ghcr.io/kubewarden/policies/pod-privileged
  isUserGroupPolicyCurrent:
    name: Is there a new user-group-psp tag
    kind: dockerimage
    sourceid: userGroupPolicyTag
    spec:
      image: ghcr.io/kubewarden/policies/user-group-psp
  isHostPathsPolicyCurrent:
    name: Is there a new hostpaths-psp tag
    kind: dockerimage
    sourceid: hostPathsPolicyTag
    spec:
      image: ghcr.io/kubewarden/policies/hostpaths-psp
  isCapabilitiesPolicyCurrent:
    name: Is there a new capabilities-psp tag
    kind: dockerimage
    sourceid: capabilitiesPolicyTag
    spec:
      image: ghcr.io/kubewarden/policies/capabilities-psp

targets:
  updatekubectlTag:
    name: Update kubectl image tag
    kind: yaml
    sourceid: kubectlImageTag
    spec:
      file: "charts/kubewarden-controller/values.yaml"
      key: "$.preDeleteJob.image.tag"
  updateAllowPrivilegeEscalationPolicyTag:
    name: Update allow-privilege-escalation-psp tag
    kind: yaml
    sourceid: allowPrivilegeEscalationPolicyTag
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.allowPrivilegeEscalationPolicy.module.tag"
  updateHostNamespacePolicyTag:
    name: Update host-namespaces-psp tag
    kind: yaml
    sourceid: hostNamespacePolicyTag
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.hostNamespacePolicy.module.tag"
  updatePodPrivilegedPolicyTag:
    name: Update pod-privileged tag
    kind: yaml
    sourceid: podPrivilegedPolicyTag
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.podPrivilegedPolicy.module.tag"
  updateUserGroupPolicyTag:
    name: Update user-group-psp tag
    kind: yaml
    sourceid: userGroupPolicyTag
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.userGroupPolicy.module.tag"
  updateHostPathsPolicyTag:
    name: Update hostpaths-psp tag
    kind: yaml
    sourceid: hostPathsPolicyTag
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.hostPathsPolicy.module.tag"
  updateCapabilitiesPolicyTag:
    name: Update capabilities-psp tag
    kind: yaml
    sourceid: capabilitiesPolicyTag
    spec:
      file: "charts/kubewarden-defaults/values.yaml"
      key: "$.recommendedPolicies.capabilitiesPolicy.module.tag"

actions:
  createUpdatePR:
    title: "deps: Update policies, kubectl image"
    kind: "github/pullrequest"
    scmid: "default"
    spec:
      automerge: false
      mergemethod: squash
      description: |
        Automatic update of dependencies: policies and kubectl image
        This PR has been created by automation.

        NOTE: REMEMBER TO SQUASH MERGE
      draft: false
      labels:
        - "kind/chore"
        - "dependencies"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      directory: "/tmp/helm-charts"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "helm-charts"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: "{{ .github.branch }}"
      commitmessage:
        type: "deps"
        title: "Update dependencies"
        hidecredit: true
